pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- pyo
-- virus containment

--------------------- todo ----

-- popping
-- gravity
-- chaining
-- power bars (by color)

---------------- callbacks ----

function new_drop()
	local a = {
		q1 = 004 + rnd"4",
		q2 = 000,
		q3 = 004 + rnd"4",
		q4 = 004 + rnd"4",
		move = move_drop
	}
	move_drop(a, true)
	return a
end

function move_drop(a, new)
	if not new then
		mset(c,0,000)
		mset(c+1,0,000)
		mset(c,1,000)
		mset(c+1,1,000)
		if btnp"4" or btnp"5" then
			sfx "02"
			gravity_drop(a.q3,c)
			gravity_drop(a.q4,c+1)
			gravity_drop(a.q1,c)
			gravity_drop(a.q2,c+1)
			combo()
			gs = start
			return
		end
		local tc = c
		if (btnp"0") c -= 1
		if (btnp"1") c += 1
		c = min(max(c,1),5)
		if(tc != c) sfx"0"
		if btnp "2" then
			sfx "01"
			local qt = a.q1
			a.q1 = a.q2
			a.q2 = a.q4
			a.q4 = a.q3
			a.q3 = qt
		end
	end
	mset(c,0,a.q1)
	mset(c+1,0,a.q2)
	mset(c,1,a.q3)
	mset(c+1,1,a.q4)
end

function gravity_drop(tile,col)
	local row=0
	repeat row+=1
	until fget(mget(col,row),0)
	mset(col,row-1,tile)
end

---------------- combo ----
function combo()
	links = {}
	for i=1,6 do
		local tt = 0
		for j=0,14 do
			local te = mget(i,j)
			if te!=0 and te==tt then
				add(links,{
					a={i=i,j=j-1},
					b={i=i,j=j},
					clr=colorfor(te)
				})
			else
				tt = te
			end
		end
	end
	for j=1,14 do
		local tt = 0
		for i=1,6 do
		local te = mget(i,j)
			if te!=0 and te==tt then
				add(links,{
					a={i=i-1,j=j},
					b={i=i,j=j},
					clr=colorfor(te)
				})
			else
				tt = te
			end
		end
	end
end

function colorfor(te)
	if (te==004) return 11
	if (te==005) return 12
	if (te==006) return 10
	if (te==007) return 14
end

----------- callbacks ----

start = {
	move = function()
		if btn"4" or btn"5" then
			gs = new_drop()
		end
	end
}

function _init()
	c = 3
	gs = start
	links = {}
end

function input()
	for n=0,5 do
		if (btnp(n)) return true
	end
end

function _update()
	if input() then
		gs:move()
	end
end

function _draw()
	cls()
	for ln in all(links) do
		rectfill(
			ln.a.i*8+3,ln.a.j*8+3,
			ln.b.i*8+5,ln.b.j*8+5,
			ln.clr
		)
	end
	map(0,0,0,0,16,16)
end
__gfx__
333333330f994000000000000000f994000000000000000000000000000000003333333333333333333333333333333333333333333333333333333333333333
300000030f994000000000000000f9940bbbbb000ccccc000aaaaa000eeeee003333333333333333333333333333333333333333333333333333333333333333
303003030f994000000000000000f9940b333bb00cccccc00a444aa00e22e2e03333333333333333333333333333333333333333333333333333333333333333
300330030f994000000000000000f9940b3b3bbb0ccccccc0aaaaaaa0e22e22e3333333333333333333333333333333333333333333333333333333333333333
300330030f994000900000000000f9940b33333b0c1c111c0a44444a0eeeeeee3333333333333333333333333333333333333333333333333333333333333333
303003030f994000900000000000f9940b3b3b3b0c1c1c1c0aaaaaaa0e22e22e3333333333333333333333333333333333333333333333333333333333333333
300000030f994000900000000000f9940b33333b0c1c111c0a44444a0e22e22e3333333333333333333333333333333333333333333333333333333333333333
333333330f994000400000000000f9940bbbbbbb0ccccccc0aaaaaaa0eeeeeee3333333333333333333333333333333333333333333333333333333333333333
000000000f994000000000000000f994000000000000000000000000000000003333333333333333333333333333333333333333333333333333333333333333
000000000f994000000000000000f994066666000666660006666600066666003333333333333333333333333333333333333333333333333333333333333333
000000000f994000000000000000f994065556600666666006555660065565603333333333333333333333333333333333333333333333333333333333333333
00000000000000000000000000000000065656660666666606666666065565563333333333333333333333333333333333333333333333333333333333333333
00000000999999999999999999999999065555560656555606555556066666663333333333333333333333333333333333333333333333333333333333333333
00000000999999999999999999999999065656560656565606666666065565563333333333333333333333333333333333333333333333333333333333333333
00000000949494949494949494949494065555560656555606555556065565563333333333333333333333333333333333333333333333333333333333333333
00000000444444444444444444444444066666660666666606666666066666663333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
__gff__
0001010101010101000000000000000000010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1112121212121213021010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100002b05032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100002605022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010800001b05300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010f00003c0331b053000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
