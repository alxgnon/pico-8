pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- pyo
-- stack files

---------------- drop ----
drop = {}

function drop.new()
	local a = {
		c = 3,
		q = {},
		move = drop.move
	}
	drop.rand(a)
	return a
end

function drop.rand(a)
	a.q[1] = 004 + rnd"4"
	a.q[2] = 000
	a.q[3] = 004 + rnd"4"
	a.q[4] = 004 + rnd"4"
	a:move(true)
end

function drop.move(a, new)
	if not new then
		drop.clear(a.c)
		if btnp"4" or btnp"5" then
			drop.hard(a.c,a.q)
			return
		end
		drop.aim(a)
		if btnp"2" then
			drop.rotate(a.q)
		end
	end
	drop.appear(a.c,a.q)
end

function drop.clear(c)
		mset(c,0,000)
		mset(c+1,0,000)
		mset(c,1,000)
		mset(c+1,1,000)
end

function drop.hard(c,q)
	sfx "02"
	drop.gravity(q[3],c)
	drop.gravity(q[4],c+1)
	drop.gravity(q[1],c)
	drop.gravity(q[2],c+1)
	combo()
	state = start
end

function drop.gravity(tile,col)
	local row=0
	repeat row+=1
	until fget(mget(col,row),0)
	mset(col,row-1,tile)
end

function drop.aim(a)
	local tc = a.c
	if (btnp"0") a.c -= 1
	if (btnp"1") a.c += 1
	a.c = min(max(a.c,1),5)
	if(tc != a.c) sfx"0"
end

function drop.rotate(q)
	sfx "01"
	local qt = q[1]
	q[1] = q[2]
	q[2] = q[4]
	q[4] = q[3]
	q[3] = qt
end

function drop.appear(c, q)
	mset(c,0,q[1])
	mset(c+1,0,q[2])
	mset(c,1,q[3])
	mset(c+1,1,q[4])
end

---------------- combo ----

function combo()
	links = {}
	local index = {}
	for i=1,6 do
		local tt = 0
		index[i] = {}
		for j=0,14 do
			local te = mget(i,j)
			if te!=0 and te==tt then
				local ln = {
					a={i=i,j=j-1},
					b={i=i,j=j},
					clr=colorfor(te)
				}
				add(links,ln)
			else
				tt = te
			end
		end
	end
	for j=1,14 do
		local tt = 0
		for i=1,6 do
		local te = mget(i,j)
			if te!=0 and te==tt then
				add(links,{
					a={i=i-1,j=j},
					b={i=i,j=j},
					clr=colorfor(te)
				})
			else
				tt = te
			end
		end
	end
end

function colorfor(te)
	if (te==004) return 11
	if (te==005) return 12
	if (te==006) return 10
	if (te==007) return 14
end

----------- callbacks ----

start = {
	move = function()
		if btn"4" or btn"5" then
			state = drop.new()
		end
	end
}

function _init()
	state = start
	links = {}
end

function input()
	for n=0,5 do
		if (btnp(n)) return true
	end
end

function _update()
	if input() then
		state:move()
	end
end

function _draw()
	cls()
	draw_links()
	map(0,0,0,0,16,16)
end

function draw_links()
	for ln in all(links) do
		rectfill(
			ln.a.i*8+3,ln.a.j*8+3,
			ln.b.i*8+5,ln.b.j*8+5,
			ln.clr
		)
	end
end
__gfx__
333333330f994000000000000000f994000000000000000000000000000000003333333333333333333333333333333333333333333333333333333333333333
300000030f994000000000000000f9940bbbbb000ccccc000aaaaa000eeeee003333333333333333333333333333333333333333333333333333333333333333
303003030f994000000000000000f9940b333bb00cccccc00a444aa00e22e2e03333333333333333333333333333333333333333333333333333333333333333
300330030f994000000000000000f9940b3b3bbb0ccccccc0aaaaaaa0e22e22e3333333333333333333333333333333333333333333333333333333333333333
300330030f994000900000000000f9940b33333b0c1c111c0a44444a0eeeeeee3333333333333333333333333333333333333333333333333333333333333333
303003030f994000900000000000f9940b3b3b3b0c1c1c1c0aaaaaaa0e22e22e3333333333333333333333333333333333333333333333333333333333333333
300000030f994000900000000000f9940b33333b0c1c111c0a44444a0e22e22e3333333333333333333333333333333333333333333333333333333333333333
333333330f994000400000000000f9940bbbbbbb0ccccccc0aaaaaaa0eeeeeee3333333333333333333333333333333333333333333333333333333333333333
333333330f994000000000000000f994000000000000000000000000000000003333333333333333333333333333333333333333333333333333333333333333
333333330f994000000000000000f994066666000666660006666600066666003333333333333333333333333333333333333333333333333333333333333333
333333330f994000000000000000f994065556600666666006555660065565603333333333333333333333333333333333333333333333333333333333333333
33333333000000000000000000000000065656660666666606666666065565563333333333333333333333333333333333333333333333333333333333333333
33333333999999999999999999999999065555560656555606555556066666663333333333333333333333333333333333333333333333333333333333333333
33333333999999999999999999999999065656560656565606666666065565563333333333333333333333333333333333333333333333333333333333333333
33333333949494949494949494949494065555560656555606555556065565563333333333333333333333333333333333333333333333333333333333333333
33333333444444444444444444444444066666660666666606666666066666663333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
__gff__
0001010101010101000000000000000000010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1112121212121213020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100002b05032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100002605022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800001b05300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
