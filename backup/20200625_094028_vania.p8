pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- vania
--
function _init()
	setup()
	texturize()
	init_player()
end

function _update()
	play()
end

function _draw()
	cls()
	camera(cam_x,cam_y)
	map(0,0,0,0,128,64)
	anime_player()
end

function init_player()
	p_t=0
	hat=16+flr(rnd(2))
	p_x=28
	p_y=114
	p_dx=0
	p_dy=0
	cam_x=0
	cam_y=0
end

function play()
	control()
	jump()
	move()
	fall()
	physics()
	zoom()
end

function control()
	if btn(0) and btn(1) then
		p_dx=0
	elseif btn(0) then
		p_dx=-3
		p_z=true
	elseif btn(1) then
		p_dx=3
		p_z=false
	end
end

function jump()
	fastfall=btn(3) and p_dy>5
	if btn(4) and not btn(3) then
		if p_land and p_rel then
			p_land=false
			p_dy=-7
		end
		p_rel=false
	else
		p_rel=true
	end
end

function move()
	local t
	if(abs(p_dx)<1)return
	for i=1,abs(p_dx) do
		p_x+=sgn(p_dx)
		for j=1,6,5 do
			local tx=(p_x+j)/8
			local ty=p_y/8
			t=mget(tx,ty)
			if fget(t,3) then
				pickup(t,tx,ty)
			end
			if fget(t,1) then
				p_x-=sgn(p_dx)
				p_dx=0
				return
			end
		end
	end
end

function fall()
	local t
	for i=1,abs(p_dy) do
		p_y+=sgn(p_dy)
		for j=1,6,5 do
			local tx=(p_x+j)/8
			local ty=p_y/8
			t=mget(tx,ty)
			if fget(t,3) then
				pickup(t,tx,ty)
			end
			if fget(t,1) then
				p_y-=sgn(p_dy)
				p_land=true
				return
			end
			p_land=false
		end
	end
end

function physics()
	if p_dx!=0 then
		p_dx-=sgn(p_dx)
	end
	if abs(p_dx)<1 then
		p_dx=0
	end
	if fastfall then
		p_dy=14
	else
		p_dy=min(p_dy+1,6)
	end
	p_t+=1
end

function pickup(t,tx,ty)
	hat=t
	mset(tx,ty,0)
end

function zoom()
	local tx,ty=p_x,p_y
	if tx<384 then
		tx=min(max(tx-60,0),256)
		ty=flr(ty/256)*256
		ty=min(max(p_y-88,ty),ty+128)
		ty=max(ty,31)
	elseif tx<896 then
		tx=min(max(tx-60,384),768)
		ty=flr(ty/128)*128
	else
		tx=min(max(tx-60,896),896)
		ty=flr(ty/128)*128
	end
	cam_x=tx
	cam_y=ty
end

function anime(f,x,y,z)
	spr(f,x,y-7,1,1,z)
end

function anime_walk(a)
	local f=33
	if p_land then
		if abs(p_dx)>1 then
			f=(32+flr(p_t/4)%4)
		end
	elseif p_dy<3 then
		f=34
	end
	return f
end

function anime_hat(f)
	local dy=(f%2==0 and 1 or 0)
	return p_y-dy-7
end

function anime_player()
	local f=anime_walk()
	local y=anime_hat(f)
	anime(hat,p_x,y,p_z)
	anime(f,p_x,p_y,p_z)
end

function setup()
	rumble=0
	hats={18,19,20,21}
end

function texturize()
	for i=0,127 do
		for j=0,63 do
			if mget(i,j)==1 then
				if rnd(100)>94 then
					mset(i,j,3)
				elseif rnd(100)>76 then
					mset(i,j,2)
				end
			elseif mget(i,j)==10 then
				if rnd(100)>40 then
					mset(i,j,9)
				end
			elseif mget(i,j)==18 then
				local t=hats[flr(rnd(#hats))+1]
				del(hats,t)
				mset(i,j,t)
			end
		end
	end
end
__gfx__
00000000665566666655665655666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666566666665665556666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666556666665566556656665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000555555555555555556555565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000566666655665566566665665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666656665666566666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666556666665566666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555555555555555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000088880000ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000088877700011aa100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007000007088888888ccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777700700000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777770000000007777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71111110777777707111111077777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71b11b107111111071b11b1071111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7111111071b11b107111111071b11b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999990711111109999999071111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04444400999999900444440099999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09000900044444009000009004444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000090009000000000090000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
