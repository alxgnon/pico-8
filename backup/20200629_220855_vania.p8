pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- vania
--
function _init()
	apply_map_texture()
	player=new_player(32,0)
end

function _update()
	update_player(player)
end

function _draw()
	draw_map_around(player)
	draw_player(player)
end

function apply_map_texture()
	for i=0,127 do
		for j=0,63 do
			if mget(i,j)==1 then
				if rnd(99)>94 then
					mset(i,j,3)
				elseif rnd(99)>76 then
					mset(i,j,2)
				end
			end
		end
	end
end

function new_player(x,y)
	return{
		t=0,
		f=48,
		x=x,
		y=y,
		dx=0,
		dy=0,
		hat=32+flr(rnd(2)),
		cam_x=0,
		cam_y=0
	}
end

function update_player(a)
	horizontal_input(a)
	vertical_input(a)
	horizontal_movement(a)
	vertical_movement(a)
	update_physics(a)
	update_camera(a)
	animate_player(a)
end

function horizontal_input(a)
	if btn(0) and btn(1) then
		a.dx=0
	elseif btn(0) then
		a.dx=-3
		a.z=true
	elseif btn(1) then
		a.dx=3
		a.z=false
	end
end

function vertical_input(a)
	if btn(4) then
		if a.land and a.rel then
			a.land=false
			a.dy=-7
		end
		a.rel=false
	else
		a.rel=true
	end
end

function horizontal_movement(a)
	local t,tx,ty
	if(abs(a.dx)<1)return
	for i=1,abs(a.dx) do
		a.x+=sgn(a.dx)
		for j=1,6,5 do
			tx=(a.x+j)/8
			ty=a.y/8
			t=mget(tx,ty)
			if fget(t,1) then
				a.x-=sgn(a.dx)
				a.dx=0
				return
			end
		end
	end
end

function vertical_movement(a)
	local t,tx,ty
	for i=1,abs(a.dy) do
		a.y+=sgn(a.dy)
		for j=1,6,5 do
			tx=(a.x+j)/8
			ty=a.y/8
			t=mget(tx,ty)
			if fget(t,1) then
				a.y-=sgn(a.dy)
				a.land=true
				return
			end
			a.land=false
		end
	end
end

function update_physics(a)
	a.t+=1
	if a.dx!=0 then
		a.dx-=sgn(a.dx)
	end
	if abs(a.dx)<1 then
		a.dx=0
	end
	a.dy=min(a.dy+1,6)
end

function update_camera(a)
	a.cam_x=min(max(a.x-60,0),256)
	a.cam_y=min(max(a.y-88,0),128)
end

function draw_map_around(a)
	cls()
	camera(a.cam_x,a.cam_y)
	map(0,0,0,0,128,64)
end

function animate_player(a)
	a.f0=1
	if a.land and abs(a.dx)>1 then
		a.f0=flr(a.t/4)%4
	elseif not a.land and a.dy<3 then
		a.f0=2
	end
	a.hat_y=(a.f0-1)%2
end

function draw_player(a)
	spr(a.f+a.f0,a.x,a.y-7,1,1,a.z)
	spr(a.hat,a.x,a.y-a.hat_y-14,1,1,a.z)
end
__gfx__
00000000665566666655665655666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666566666665665556666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666556666665566556656665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000555555555555555556555565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000566666655665566566665665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666656665666566666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666556666665566666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555555555555555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000088880000ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000088877700055aa500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007000007088888888ccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777700700000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777770000000007777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71111110777777707111111077777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71b11b107111111071b11b1071111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7111111071b11b107111111071b11b10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999990711111109999999071111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04444400999999900444440099999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09000900044444009000009004444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000090009000000000090000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0100000000000000000000000000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
